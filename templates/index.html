{% extends "base.html" %} {% block content %}
<div
  class="flex flex-col gap-3 mb-6 sm:flex-row sm:justify-between sm:items-center"
>
  <!-- title row: title + theme toggle + mobile add button -->
  <div class="flex items-center justify-between">
    <div class="flex items-center gap-3">
      <h1 class="text-2xl sm:text-3xl font-bold">shelf</h1>
      <label class="swap swap-rotate">
        <input type="checkbox" id="theme-toggle" onclick="toggleTheme()" />
        <span
          class="swap-on w-6 h-6 bg-current"
          style="
            -webkit-mask: url(/static/icons/sun.svg) center/contain no-repeat;
            mask: url(/static/icons/sun.svg) center/contain no-repeat;
          "
        ></span>
        <span
          class="swap-off w-6 h-6 bg-current"
          style="
            -webkit-mask: url(/static/icons/moon.svg) center/contain no-repeat;
            mask: url(/static/icons/moon.svg) center/contain no-repeat;
          "
        ></span>
      </label>
    </div>
    <!-- mobile-only add button -->
    <button
      id="add-btn-mobile"
      class="btn btn-primary btn-sm sm:hidden"
      hx-get="/modal/media/new"
      hx-target="#modal-container"
    >
      +
    </button>
  </div>

  <!-- section toggle - full width on mobile -->
  <div class="join w-full sm:w-auto">
    <button
      id="section-media"
      class="btn btn-sm join-item flex-1 sm:flex-none btn-active"
      onclick="switchSection('media')"
    >
      media
    </button>
    <button
      id="section-workouts"
      class="btn btn-sm join-item flex-1 sm:flex-none"
      onclick="switchSection('workouts')"
    >
      workouts
    </button>
  </div>

  <!-- desktop add button -->
  <button
    id="add-btn"
    class="btn btn-primary hidden sm:block"
    hx-get="/modal/media/new"
    hx-target="#modal-container"
  >
    add media
  </button>
</div>

<div id="main-content">
  <!-- media section -->
  <div id="media-section">
    <div role="tablist" class="tabs tabs-boxed mb-6">
      <a
        role="tab"
        class="tab"
        data-status="queued"
        hx-get="/media-items?status=queued"
        hx-target="#media-content"
        hx-on::after-request="setActiveTab(this, 'queued')"
      >
        queued
      </a>
      <a
        role="tab"
        class="tab"
        data-status="watching"
        hx-get="/media-items?status=watching"
        hx-target="#media-content"
        hx-on::after-request="setActiveTab(this, 'watching')"
      >
        watching
      </a>
      <a
        role="tab"
        class="tab"
        data-status="watched"
        hx-get="/media-items?status=watched"
        hx-target="#media-content"
        hx-on::after-request="setActiveTab(this, 'watched')"
      >
        watched
      </a>
    </div>

    <div id="media-content">
      <span class="loading loading-spinner loading-lg"></span>
    </div>
  </div>

  <!-- workout section (hidden by default) -->
  <div id="workout-section" class="hidden">
    <div id="workout-content" hx-get="/workout-items" hx-trigger="revealed">
      <span class="loading loading-spinner loading-lg"></span>
    </div>
  </div>
</div>

<script>
  function setActiveTab(clickedTab, status) {
    document.querySelectorAll('[role="tab"]').forEach((tab) => {
      tab.classList.remove("tab-active");
    });
    clickedTab.classList.add("tab-active");
    localStorage.setItem("shelf-media-tab", status);
  }

  function switchSection(section) {
    const mediaSection = document.getElementById("media-section");
    const workoutSection = document.getElementById("workout-section");
    const mediaBtn = document.getElementById("section-media");
    const workoutBtn = document.getElementById("section-workouts");
    const addBtn = document.getElementById("add-btn");
    const addBtnMobile = document.getElementById("add-btn-mobile");

    localStorage.setItem("shelf-section", section);

    if (section === "media") {
      mediaSection.classList.remove("hidden");
      workoutSection.classList.add("hidden");
      mediaBtn.classList.add("btn-active");
      workoutBtn.classList.remove("btn-active");
      addBtn.textContent = "add media";
      addBtn.setAttribute("hx-get", "/modal/media/new");
      addBtnMobile.setAttribute("hx-get", "/modal/media/new");
      htmx.process(addBtn);
      htmx.process(addBtnMobile);
    } else {
      mediaSection.classList.add("hidden");
      workoutSection.classList.remove("hidden");
      mediaBtn.classList.remove("btn-active");
      workoutBtn.classList.add("btn-active");
      addBtn.textContent = "add workout";
      addBtn.setAttribute("hx-get", "/modal/workout/new");
      addBtnMobile.setAttribute("hx-get", "/modal/workout/new");
      htmx.process(addBtn);
      htmx.process(addBtnMobile);
    }
  }

  // restore state on page load
  document.addEventListener("DOMContentLoaded", function () {
    const savedSection = localStorage.getItem("shelf-section") || "media";
    const savedTab = localStorage.getItem("shelf-media-tab") || "queued";

    // restore section
    switchSection(savedSection);

    // restore media tab and load content
    const tab = document.querySelector(`[data-status="${savedTab}"]`);
    if (tab) {
      tab.classList.add("tab-active");
      htmx.ajax("GET", `/media-items?status=${savedTab}`, "#media-content");
    } else {
      document
        .querySelector('[data-status="queued"]')
        .classList.add("tab-active");
      htmx.ajax("GET", "/media-items?status=queued", "#media-content");
    }
  });
</script>
{% endblock %}
