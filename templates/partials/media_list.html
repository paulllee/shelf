{% if media_items %}
<div class="flex flex-col gap-2 sm:flex-row sm:gap-4 mb-4">
  <div class="form-control">
    <select
      id="filter-type"
      class="select select-bordered select-sm w-full sm:w-auto"
      onchange="filterMedia()"
    >
      <option value="">all types</option>
      {% set types = media_items | map(attribute='type') | unique | sort %} {%
      for t in types %} {% if t.name != "UNDEFINED" %}
      <option value="{{ t.name.lower() }}">{{ t.name.lower() }}</option>
      {% endif %} {% endfor %}
    </select>
  </div>
  <div class="form-control">
    <select
      id="filter-country"
      class="select select-bordered select-sm w-full sm:w-auto"
      onchange="filterMedia()"
    >
      <option value="">all countries</option>
      {% set countries = media_items | map(attribute='country') | unique | sort
      %} {% for c in countries %} {% if c.name != "UNDEFINED" %}
      <option value="{{ c.name.lower() }}">{{ c.name.lower() }}</option>
      {% endif %} {% endfor %}
    </select>
  </div>
</div>

<!-- Mobile card view -->
<div id="media-cards" class="space-y-2 md:hidden">
  {% for item in media_items %}
  <div
    class="media-card bg-base-200 rounded-lg p-3 active:bg-base-300 cursor-pointer"
    data-type="{{ item.type_str }}"
    data-country="{{ item.country_str }}"
    hx-get="/modal/media/{{ item.id }}/edit?viewing_status={{ current_status }}"
    hx-target="#modal-container"
  >
    <div class="flex justify-between items-start">
      <span class="font-medium">{{ item.name }}</span>
      {% if item.rating and item.rating != "n/a" %}
      <span class="badge badge-primary badge-sm">{{ item.rating }}</span>
      {% endif %}
    </div>
    <div class="text-sm text-base-content/60 mt-1">
      {% if item.type_str != "undefined" %}{{ item.type_str }}{% endif %}{% if
      item.type_str != "undefined" and item.country_str != "undefined" %} · {%
      endif %}{% if item.country_str != "undefined" %}{{ item.country_str }}{%
      endif %}
    </div>
  </div>
  {% endfor %}
</div>

<!-- Desktop table view -->
<div class="hidden md:block overflow-auto max-h-[70vh] rounded-lg">
  <table id="media-table" class="table table-zebra w-full bg-base-100">
    <thead class="sticky top-0 bg-base-100 z-10">
      <tr class="border-b-2 border-base-300">
        <th
          class="text-left cursor-pointer select-none hover:bg-base-200"
          data-sort="title"
          onclick="sortTable(this, 0)"
        >
          title <span class="sort-indicator text-xs opacity-50"></span>
        </th>
        <th
          class="text-left w-24 cursor-pointer select-none hover:bg-base-200"
          data-sort="type"
          onclick="sortTable(this, 1)"
        >
          type <span class="sort-indicator text-xs opacity-50"></span>
        </th>
        <th
          class="text-left w-24 cursor-pointer select-none hover:bg-base-200"
          data-sort="country"
          onclick="sortTable(this, 2)"
        >
          country <span class="sort-indicator text-xs opacity-50"></span>
        </th>
        <th
          class="text-left w-20 cursor-pointer select-none hover:bg-base-200"
          data-sort="rating"
          onclick="sortTable(this, 3)"
        >
          rating <span class="sort-indicator text-xs opacity-50"></span>
        </th>
        <th class="w-16"></th>
      </tr>
    </thead>
    <tbody>
      {% for item in media_items %} {% include "partials/media_card.html" %} {%
      endfor %}
    </tbody>
  </table>
</div>

<script>
  function filterMedia() {
    const typeFilter = document
      .getElementById("filter-type")
      .value.toLowerCase();
    const countryFilter = document
      .getElementById("filter-country")
      .value.toLowerCase();

    // Filter table rows (desktop)
    const rows = document.querySelectorAll("#media-table tbody tr");
    rows.forEach((row) => {
      const type = row.children[1].textContent.trim().toLowerCase();
      const country = row.children[2].textContent.trim().toLowerCase();

      const typeMatch = !typeFilter || type === typeFilter;
      const countryMatch = !countryFilter || country === countryFilter;

      row.style.display = typeMatch && countryMatch ? "" : "none";
    });

    // Filter cards (mobile)
    const cards = document.querySelectorAll("#media-cards .media-card");
    cards.forEach((card) => {
      const type = card.dataset.type.toLowerCase();
      const country = card.dataset.country.toLowerCase();

      const typeMatch = !typeFilter || type === typeFilter;
      const countryMatch = !countryFilter || country === countryFilter;

      card.style.display = typeMatch && countryMatch ? "" : "none";
    });
  }

  function sortTable(header, colIndex) {
    const table = header.closest("table");
    const tbody = table.querySelector("tbody");
    const rows = Array.from(tbody.querySelectorAll("tr"));
    const headers = table.querySelectorAll("th[data-sort]");

    // determine sort direction
    const currentDir = header.getAttribute("data-dir");
    const newDir = currentDir === "asc" ? "desc" : "asc";

    // reset all headers
    headers.forEach((h) => {
      h.removeAttribute("data-dir");
      h.querySelector(".sort-indicator").textContent = "";
    });

    // set current header
    header.setAttribute("data-dir", newDir);
    header.querySelector(".sort-indicator").textContent =
      newDir === "asc" ? " ▲" : " ▼";

    // sort rows
    rows.sort((a, b) => {
      let aVal = a.children[colIndex].textContent.trim().toLowerCase();
      let bVal = b.children[colIndex].textContent.trim().toLowerCase();

      // handle numeric sorting for rating
      if (colIndex === 3) {
        aVal = aVal === "-" ? -1 : parseFloat(aVal) || 0;
        bVal = bVal === "-" ? -1 : parseFloat(bVal) || 0;
        return newDir === "asc" ? aVal - bVal : bVal - aVal;
      }

      // string sorting
      if (newDir === "asc") {
        return aVal.localeCompare(bVal);
      } else {
        return bVal.localeCompare(aVal);
      }
    });

    // re-append sorted rows
    rows.forEach((row) => tbody.appendChild(row));
  }
</script>
{% else %}
<div class="text-center py-12 text-base-content/60 bg-base-100 rounded-lg">
  <p>no media items in this list</p>
</div>
{% endif %}
